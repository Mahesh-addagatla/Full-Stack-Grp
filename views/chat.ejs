<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <!-- Optional: Add your CSS file for styling -->
  </head>
  <body>
    <h1>Chat Room - <%= user.location %></h1>
    <div id="chat-box"></div>

    <form id="chat-form" action="/chat" method="POST">
      <input
        type="text"
        name="message"
        id="message-input"
        placeholder="Type your message..."
        required
      />
      <button type="submit">Send</button>
    </form>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDINlS7PqxjzKuarFE5Rr7_jQ84DLwjCOM",
        authDomain: "node401app.firebaseapp.com",
        databaseURL: "https://node401app-default-rtdb.firebaseio.com",
        projectId: "node401app",
        storageBucket: "node401app.appspot.com",
        messagingSenderId: "166278817365",
        appId: "1:166278817365:web:4585d2858221e5bc2a96dc",
        measurementId: "G-JWX0GWT5T3",
      };

      // Initialize Firebase
      const app = firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // Fetch and display chat messages
      const chatBox = document.getElementById("chat-box");
      const userLocation = "<%= user.location %>";

      db.ref(`Cities/${userLocation}/Chats`).on("child_added", (snapshot) => {
        const messageData = snapshot.val();
        const messageElement = document.createElement("p");
        messageElement.textContent = `${messageData.userName}: ${messageData.message}`;
        chatBox.appendChild(messageElement);
      });

      // Submit chat message form via AJAX
      document
        .getElementById("chat-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const messageInput = document.getElementById("message-input");
          const message = messageInput.value;

          try {
            const response = await fetch("/chat", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ message }),
            });

            if (response.ok) {
              messageInput.value = ""; // Clear input field on success
            } else {
              console.error("Error sending message:", await response.text());
            }
          } catch (error) {
            console.error("Error:", error);
          }
        });
    </script>
  </body>
</html>
